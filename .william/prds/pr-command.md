# PRD: PR Command

## Introduction

Add a `william pr <workspace-name>` command that pushes the workspace branch and creates (or updates) a GitHub pull request. The PR title and description are generated by Claude via a prompt template, using the workspace's PRD and git history as context. The output must read like a human wrote it — no AI-generated tells.

## Goals

- Allow users to open a PR for any workspace with a single command
- Generate a high-quality PR title and description from the PRD and actual work done
- Ensure the PR content looks naturally human-written
- Update an existing PR if one already exists for the branch
- Warn (but don't block) when a workspace has incomplete stories

## User Stories

### US-001: Add `william pr` CLI command

**Description:** As a user, I want to run `william pr <workspace-name>` so that I can open a PR without leaving my terminal.

**Acceptance Criteria:**

- [ ] `william pr <workspace-name>` is a registered command in `src/cli.ts`
- [ ] Resolves the workspace using the existing `resolveWorkspace()` function
- [ ] Errors with a clear message if the workspace has no `worktreePath` (legacy workspace)
- [ ] Errors if the worktree directory does not exist on disk
- [ ] Typecheck and lint pass

### US-002: Push workspace branch to remote

**Description:** As a user, I want `william pr` to push the worktree branch to the remote so the PR has the latest code.

**Acceptance Criteria:**

- [ ] Runs `git push -u origin <branchName>` inside the worktree directory
- [ ] If the branch has already been pushed, runs a regular `git push`
- [ ] Surfaces git push errors clearly to the user (e.g. permission denied, no remote)
- [ ] Typecheck and lint pass

### US-003: Detect existing PR for branch

**Description:** As a user, if a PR already exists for my branch I want william to update it instead of trying to create a duplicate.

**Acceptance Criteria:**

- [ ] Uses `gh pr list --head <branchName> --json number,url` (or equivalent) to check for an existing PR targeting `main`
- [ ] If a PR exists, stores the PR number for use in the update step (US-005)
- [ ] If no PR exists, proceeds to create one (US-004)
- [ ] Typecheck and lint pass

### US-004: Generate PR title and description via Claude

**Description:** As a user, I want the PR title and body to be auto-generated from my PRD and the actual work done, so I don't have to write it manually.

**Acceptance Criteria:**

- [ ] A prompt template exists at `templates/pr-description-instructions.md`
- [ ] The template instructs Claude to produce a JSON object with `title` and `body` fields
- [ ] The template receives the full PRD markdown, the git diff (`git diff main...<branch>`), the git log (`git log main..<branch> --oneline`), and the workspace state (story completion status)
- [ ] The template explicitly instructs Claude to write like a human engineer — no "this PR", no "this change", no emoji, no "AI-generated" phrasing, no `Co-Authored-By` trailer
- [ ] Claude is spawned using the existing Claude adapter (or a simpler `execFile`/`spawn` call) with the assembled prompt
- [ ] The JSON response is parsed to extract `title` and `body`
- [ ] Typecheck and lint pass

### US-005: Create or update the GitHub PR

**Description:** As a user, I want the PR to be created on GitHub (or updated if one already exists) so I can share my work for review.

**Acceptance Criteria:**

- [ ] If no existing PR: runs `gh pr create --base main --title <title> --body <body>` inside the worktree
- [ ] If existing PR: runs `gh pr edit <number> --title <title> --body <body>` inside the worktree
- [ ] Prints the PR URL to the terminal on success
- [ ] Surfaces `gh` errors clearly (e.g. not authenticated, repo not found)
- [ ] Typecheck and lint pass

### US-006: Warn on incomplete workspace

**Description:** As a user, I want to be warned if my workspace has pending or skipped stories so I know the PR may represent partial work, but I should still be able to proceed.

**Acceptance Criteria:**

- [ ] Before pushing, checks the workspace state for any stories that are not `passes: true`
- [ ] If incomplete stories exist, prints a warning listing the pending/skipped story IDs
- [ ] Does NOT block the PR — proceeds after printing the warning
- [ ] If all stories are complete, no warning is printed
- [ ] Typecheck and lint pass

### US-007: Support `--draft` flag

**Description:** As a user, I want to open a draft PR so I can share work-in-progress without signaling it's ready for review.

**Acceptance Criteria:**

- [ ] `william pr <workspace-name> --draft` is accepted as a valid flag
- [ ] When `--draft` is passed, `gh pr create` includes the `--draft` flag
- [ ] When updating an existing PR with `--draft`, the PR is converted to draft via `gh pr ready --undo`
- [ ] The printed PR URL still works correctly for draft PRs
- [ ] Typecheck and lint pass

### US-008: Support `--dry-run` flag

**Description:** As a user, I want to preview the generated PR title and description without actually creating or pushing anything, so I can review before committing to it.

**Acceptance Criteria:**

- [ ] `william pr <workspace-name> --dry-run` is accepted as a valid flag
- [ ] When `--dry-run` is passed, the branch is NOT pushed and no PR is created or updated
- [ ] The generated title and body are printed to the terminal for review
- [ ] Clearly labeled as a dry run in the output (e.g. "Dry run — no PR created")
- [ ] Typecheck and lint pass

## Functional Requirements

- FR-1: Register `william pr <workspace-name>` as a CLI command using commander
- FR-2: Resolve the workspace name via `resolveWorkspace()` and load its `state.json`
- FR-3: Validate that `worktreePath` exists in state and on disk; error if not
- FR-4: Check story completion status and warn if any stories are pending or skipped
- FR-5: Run `git push -u origin <branchName>` inside the worktree directory
- FR-6: Check for an existing PR on the branch using the `gh` CLI
- FR-7: Build a prompt from `templates/pr-description-instructions.md` with PRD content, git diff, git log, and story status as context
- FR-8: Spawn Claude with the prompt and parse the JSON response for `title` and `body`
- FR-9: Create a new PR via `gh pr create` or update an existing one via `gh pr edit`
- FR-10: Print the resulting PR URL to the terminal
- FR-11: When `--draft` is passed, create the PR as a draft (or convert an existing PR to draft)
- FR-12: When `--dry-run` is passed, skip pushing and PR creation; print the generated title and body to the terminal instead

## Non-Goals

- No pre-push quality checks (typecheck/lint) — CI handles this
- No interactive editing of the PR description before submission
- No support for custom target branches (always `main`)
- No PR label or reviewer assignment

## Technical Considerations

- The `gh` CLI must be installed and authenticated — error clearly if not
- Claude is spawned as a subprocess (consistent with the existing adapter pattern in `src/adapters/claude.ts`)
- The prompt template uses the same `{{placeholder}}` convention as `templates/agent-instructions.md`
- Git diff can be large — consider truncating if it exceeds a reasonable size (e.g. 100KB) to avoid context window issues
- The PR command module should live at `src/pr.ts` with the CLI wiring in `src/cli.ts`

## Success Metrics

- User can go from finished workspace to open PR in a single command
- PR descriptions are indistinguishable from human-written ones
- Existing PRs are updated in place rather than duplicated

## Open Questions

None — all resolved.
